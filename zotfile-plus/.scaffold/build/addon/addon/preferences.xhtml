<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="chrome://global/skin/global.css" type="text/css"?>
<dialog xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
        xmlns:html="http://www.w3.org/1999/xhtml"
        id="zotfileplus-prefs"
        title="ZotFile+ Preferences"
        buttons="accept,cancel"
        onload="ZotFilePlus_Prefs_Init();"
        ondialogaccept="if (ZotFilePlus_Prefs_Validate()) { onDialogAccept(); return true; } return false;"
        width="600"
        height="500">

  <script>
    const { Services } = ChromeUtils.import("resource://gre/modules/Services.jsm");
    
    // Initialize preferences when dialog loads
    function ZotFilePlus_Prefs_Init() {
      // Load current preferences
      document.getElementById('renamePattern').value = 
        Services.prefs.getCharPref('extensions.zotfileplus.renamePattern', '{%a_}{%y_}{%t}');
      document.getElementById('renameFormat_patent').value = 
        Services.prefs.getCharPref('extensions.zotfileplus.renameFormat_patent', '{%t} - {%y}');
      
      document.getElementById('maxTitleLength').value = 
        Services.prefs.getIntPref('extensions.zotfileplus.maxTitleLength', 80);
      document.getElementById('truncateTitle').checked = 
        Services.prefs.getBoolPref('extensions.zotfileplus.truncateTitle', true);
      document.getElementById('smartTruncate').checked = 
        Services.prefs.getBoolPref('extensions.zotfileplus.smartTruncate', true);
      
      document.getElementById('maxAuthors').value = 
        Services.prefs.getIntPref('extensions.zotfileplus.maxAuthors', 3);
      document.getElementById('truncateAuthors').checked = 
        Services.prefs.getBoolPref('extensions.zotfileplus.truncateAuthors', true);
      document.getElementById('addEtAl').checked = 
        Services.prefs.getBoolPref('extensions.zotfileplus.addEtAl', true);
      document.getElementById('etAlString').value = 
        Services.prefs.getCharPref('extensions.zotfileplus.etAlString', ' et al');
      document.getElementById('authorsDelimiter').value = 
        Services.prefs.getCharPref('extensions.zotfileplus.authorsDelimiter', '_');
      
      document.getElementById('removeDiacritics').checked = 
        Services.prefs.getBoolPref('extensions.zotfileplus.removeDiacritics', false);
      document.getElementById('removePeriods').checked = 
        Services.prefs.getBoolPref('extensions.zotfileplus.removePeriods', false);
      document.getElementById('replaceBlanks').checked = 
        Services.prefs.getBoolPref('extensions.zotfileplus.replaceBlanks', false);
      document.getElementById('toLowerCase').checked = 
        Services.prefs.getBoolPref('extensions.zotfileplus.toLowerCase', false);
      
      document.getElementById('customWildcards').value = 
        Services.prefs.getCharPref('extensions.zotfileplus.customWildcards', '{}');
    }
    
    // Validate preferences before saving
    function ZotFilePlus_Prefs_Validate() {
      // Validate JSON for custom wildcards
      try {
        const customWildcardsValue = document.getElementById('customWildcards').value;
        if (customWildcardsValue.trim() && customWildcardsValue.trim() !== '{}') {
          JSON.parse(customWildcardsValue);
        }
        return true;
      } catch (e) {
        alert('Invalid JSON in Custom Wildcards:\n\n' + e.message);
        return false;
      }
    }
    
    // Called when the OK button is clicked
    function onDialogAccept() {
      // Save preferences
      Services.prefs.setCharPref('extensions.zotfileplus.renamePattern', 
        document.getElementById('renamePattern').value);
      Services.prefs.setCharPref('extensions.zotfileplus.renameFormat_patent', 
        document.getElementById('renameFormat_patent').value);
      
      Services.prefs.setIntPref('extensions.zotfileplus.maxTitleLength', 
        parseInt(document.getElementById('maxTitleLength').value));
      Services.prefs.setBoolPref('extensions.zotfileplus.truncateTitle', 
        document.getElementById('truncateTitle').checked);
      Services.prefs.setBoolPref('extensions.zotfileplus.smartTruncate', 
        document.getElementById('smartTruncate').checked);
      
      Services.prefs.setIntPref('extensions.zotfileplus.maxAuthors', 
        parseInt(document.getElementById('maxAuthors').value));
      Services.prefs.setBoolPref('extensions.zotfileplus.truncateAuthors', 
        document.getElementById('truncateAuthors').checked);
      Services.prefs.setBoolPref('extensions.zotfileplus.addEtAl', 
        document.getElementById('addEtAl').checked);
      Services.prefs.setCharPref('extensions.zotfileplus.etAlString', 
        document.getElementById('etAlString').value);
      Services.prefs.setCharPref('extensions.zotfileplus.authorsDelimiter', 
        document.getElementById('authorsDelimiter').value);
      
      Services.prefs.setBoolPref('extensions.zotfileplus.removeDiacritics', 
        document.getElementById('removeDiacritics').checked);
      Services.prefs.setBoolPref('extensions.zotfileplus.removePeriods', 
        document.getElementById('removePeriods').checked);
      Services.prefs.setBoolPref('extensions.zotfileplus.replaceBlanks', 
        document.getElementById('replaceBlanks').checked);
      Services.prefs.setBoolPref('extensions.zotfileplus.toLowerCase', 
        document.getElementById('toLowerCase').checked);
      
      Services.prefs.setCharPref('extensions.zotfileplus.customWildcards', 
        document.getElementById('customWildcards').value);
      
      // Reload plugin to apply changes (if the plugin is available)
      try {
        if (window.Zotero && window.Zotero.ZotFilePlus) {
          // Reload custom wildcards
          window.Zotero.ZotFilePlus.loadCustomWildcards();
        }
      } catch (e) {
        console.log("Could not reload plugin after preferences change: " + e.message);
      }
    }
  </script>
  
  <vbox flex="1">
    <groupbox>
      <caption label="Rename Pattern"/>
      <hbox align="center">
        <label value="Default Pattern:" control="renamePattern"/>
        <textbox id="renamePattern" flex="1"/>
      </hbox>
      <hbox align="center">
        <label value="Patent Pattern:" control="renameFormat_patent"/>
        <textbox id="renameFormat_patent" flex="1"/>
      </hbox>
      <description>
        Examples: {%a_}{%y_}{%t} → Smith_2023_Machine_Learning.pdf
        {%a_}{%y}_{%j} → Smith_2023_Nature.pdf
      </description>
      <description>
        Wildcards: %a=author, %y=year, %t=title, %j=journal, %c=collection
      </description>
    </groupbox>
    
    <groupbox>
      <caption label="Title Formatting"/>
      <hbox align="center">
        <label value="Maximum Title Length:" control="maxTitleLength"/>
        <textbox id="maxTitleLength" type="number" min="10" max="500" size="5"/>
      </hbox>
      <hbox align="center">
        <checkbox id="truncateTitle" label="Truncate after punctuation (:.?!:)"/>
      </hbox>
      <hbox align="center">
        <checkbox id="smartTruncate" label="Smart truncation at word boundaries"/>
      </hbox>
    </groupbox>
    
    <groupbox>
      <caption label="Author Formatting"/>
      <hbox align="center">
        <label value="Maximum Authors:" control="maxAuthors"/>
        <textbox id="maxAuthors" type="number" min="1" max="20" size="5"/>
      </hbox>
      <hbox align="center">
        <checkbox id="truncateAuthors" label="Truncate multiple authors"/>
      </hbox>
      <hbox align="center" style="margin-left: 20px;">
        <checkbox id="addEtAl" label="Add 'et al' after first author"/>
      </hbox>
      <hbox align="center" style="margin-left: 20px;">
        <label value="Et al string:" control="etAlString"/>
        <textbox id="etAlString"/>
      </hbox>
      <hbox align="center">
        <label value="Author Delimiter:" control="authorsDelimiter"/>
        <textbox id="authorsDelimiter" maxlength="5"/>
      </hbox>
    </groupbox>
    
    <groupbox>
      <caption label="Text Processing"/>
      <checkbox id="removeDiacritics" label="Remove diacritics (ä→a, é→e, etc.)"/>
      <checkbox id="removePeriods" label="Remove periods"/>
      <checkbox id="replaceBlanks" label="Replace blanks with underscores"/>
      <checkbox id="toLowerCase" label="Convert to lowercase"/>
    </groupbox>
    
    <groupbox>
      <caption label="Custom Wildcards"/>
      <vbox>
        <label value="Custom Wildcards (JSON):"/>
        <textbox id="customWildcards" multiline="true" rows="4" cols="60" 
                placeholder='{&quot;k&quot;: &quot;DOI&quot;, &quot;u&quot;: &quot;url&quot;}'
                tooltiptext="Define custom wildcards as JSON. Example: {&quot;k&quot;: &quot;DOI&quot;} creates %k wildcard for DOI field."/>
      </vbox>
    </groupbox>
  </vbox>
</dialog>